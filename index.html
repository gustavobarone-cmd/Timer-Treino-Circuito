<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Timer Circuito ‚Äî Minha Voz (HAJIME / KOTAI / MATE)</title>

  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b1020;color:#eef2ff}
    .wrap{max-width:920px;margin:0 auto;padding:14px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);border-radius:16px;padding:14px;margin:10px 0}
    h1{margin:0 0 6px;font-size:18px}
    .mut{color:#b7c3ee;font-size:13px;line-height:1.35}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    button{padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.18);color:#eef2ff;font-weight:800;font-size:16px}
    button:active{transform:translateY(1px)}
    .ok{background:rgba(61,220,151,.85);color:#06120d}
    .warn{background:rgba(255,209,102,.9);color:#1b1200}
    .bad{background:rgba(255,93,93,.9);color:#1b0000}
    label{display:block;margin-top:10px;color:#b7c3ee;font-size:13px}
    input,select,textarea{width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.20);color:#eef2ff}
    textarea{min-height:110px}
    .big{font-size:64px;font-weight:900;text-align:center;margin:8px 0}
    .name{font-size:22px;font-weight:900;text-align:center;margin:0}
    .badge{position:fixed;top:10px;left:10px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:999px;font-size:12px;z-index:9999}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.18);padding:10px 12px;border-radius:999px;font-size:13px;opacity:0;transition:opacity .2s;max-width:92vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;z-index:9999}
    .toast.on{opacity:1}
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal{max-width:900px;width:96vw;max-height:88vh;overflow:auto;background:#0b1020;border:1px solid rgba(255,255,255,.16);border-radius:16px;padding:14px}
  </style>

  <script>
    // Se der erro JS, mostra em vermelho em cima
    window.addEventListener('error', (e)=>{
      const d=document.createElement('div');
      d.className='badge';
      d.style.background='#b00020';
      d.textContent='ERRO JS: '+(e.message||'')+' @ '+(e.filename||'')+':'+(e.lineno||'');
      document.documentElement.appendChild(d);
    });
  </script>
</head>

<body>
  <div class="badge" id="badge">‚è≥ carregando‚Ä¶</div>
  <div class="toast" id="toast"></div>

  <div class="modalBack" id="mb">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <b>Guia do usu√°rio</b>
        <button id="closeGuide" style="width:auto">Fechar</button>
      </div>
      <p class="mut">
        <b>Primeira vez (em casa):</b><br>
        1) Abra em <b>HTTPS</b> (GitHub Pages).<br>
        2) Toque <b>Ativar √°udio</b>.<br>
        3) Toque <b>Configurar microfone</b> ‚Üí <b>Permitir</b>.<br>
        4) Grave <b>HAJIME</b> e <b>KOTAI</b> (ou <b>MATE</b>). Opcional: grave ‚Äú<b>5..1</b>‚Äù.<br>
        5) Toque <b>Iniciar</b>: fala HAJIME e come√ßa 30s; no fim fala KOTAI (troca) ou MATE (parar).<br><br>

        <b>No treino:</b><br>
        ‚Ä¢ <b>MATE</b> para tudo imediatamente e fala ‚ÄúMATE‚Äù.<br>
        ‚Ä¢ <b>Descanso 30s</b> reinicia o circuito e faz um descanso extra.<br><br>

        Dica: aumente o volume de m√≠dia do celular. Para ‚Äúbem alto‚Äù, use caixinha Bluetooth.
      </p>
    </div>
  </div>

  <div class="wrap">
    <h1>Timer Circuito ‚Äî s√≥ minha voz (HAJIME / KOTAI / MATE)</h1>
    <div class="mut">
      Se o site abrir e os bot√µes ‚Äúclicarem‚Äù mas n√£o fizerem nada, normalmente √© JavaScript desativado no Chrome.
    </div>

    <div class="card">
      <p class="name" id="exName">Pronto</p>
      <div class="big" id="time">00:30</div>
      <div class="mut" style="text-align:center" id="phase">Parado</div>

      <div class="row">
        <button class="ok" id="start">Iniciar</button>
        <button id="pause">Pausar</button>
      </div>

      <div class="row">
        <button id="reset">Zerar</button>
        <button class="bad" id="rest30">Descanso 30s</button>
      </div>

      <div class="row">
        <button class="warn" id="next">Pr√≥ximo</button>
        <button id="full">Tela cheia</button>
      </div>

      <div class="row">
        <button class="bad" id="mateBtn">MATE</button>
        <button class="ok" id="audio">Ativar √°udio</button>
      </div>

      <div class="row">
        <button class="ok" id="mic">Configurar microfone</button>
        <button id="guide">Guia do usu√°rio</button>
      </div>

      <div class="row">
        <button id="save">Salvar config</button>
        <button id="load">Carregar config</button>
      </div>

      <div class="row">
        <button class="bad" id="clearRecs">Apagar grava√ß√µes</button>
        <button id="noop"> </button>
      </div>
    </div>

    <div class="card">
      <b>Configura√ß√µes</b>

      <label>Trabalho (segundos)
        <input id="work" type="number" min="5" max="600" value="30">
      </label>

      <label>Intervalo (segundos)
        <input id="rest" type="number" min="0" max="600" value="10">
      </label>

      <label>Janela final do intervalo (segundos) para tocar ‚Äú5..1‚Äù
        <input id="cd" type="number" min="0" max="20" value="5">
      </label>

      <label>Contagem no intervalo
        <select id="cdMode">
          <option value="silent" selected>Silenciosa</option>
          <option value="clip">Minha voz (um √°udio ‚Äú5..1‚Äù)</option>
          <option value="off">Desligada</option>
        </select>
      </label>

      <label>Voltas no circuito
        <input id="rounds" type="number" min="1" max="50" value="1">
      </label>

      <label>Comando no fim dos 30s
        <select id="endCmd">
          <option value="kotai" selected>KOTAI (troca)</option>
          <option value="mate">MATE (parar)</option>
          <option value="none">Nenhum</option>
        </select>
      </label>

      <label>Lista de exerc√≠cios (um por linha)
        <textarea id="list">Polichinelos
Agachamento
Flex√£o
Prancha</textarea>
      </label>
    </div>

    <div class="card">
      <b>Grava√ß√µes (minha voz)</b>
      <div class="row">
        <button id="recStart">üéôÔ∏è Gravar HAJIME</button>
        <button id="testStart">‚ñ∂Ô∏è Testar HAJIME</button>
      </div>
      <div class="row">
        <button id="recKotai">üéôÔ∏è Gravar KOTAI</button>
        <button id="testKotai">‚ñ∂Ô∏è Testar KOTAI</button>
      </div>
      <div class="row">
        <button id="recMate">üéôÔ∏è Gravar MATE</button>
        <button id="testMate">‚ñ∂Ô∏è Testar MATE</button>
      </div>
      <div class="row">
        <button id="recCount">üéôÔ∏è Gravar ‚Äú5..1‚Äù</button>
        <button id="testCount">‚ñ∂Ô∏è Testar ‚Äú5..1‚Äù</button>
      </div>
      <div class="mut">Obs.: para gravar, precisa permitir microfone no Chrome/Android.</div>
    </div>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const toast=(m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('on'); clearTimeout(toast._); toast._=setTimeout(()=>t.classList.remove('on'),1800); };

  // APP ATIVO (se voc√™ ver isso, JS est√° rodando)
  $('badge').textContent = '‚úÖ APP ATIVO';

  // AudioContext (fallback beep)
  let ac=null, audioOn=false;
  const ensureAC=()=>{ if(ac) return true; try{ ac=new (window.AudioContext||window.webkitAudioContext)(); return true; }catch(e){ return false; } };
  const beep=(f=1200,ms=70)=>{ if(!audioOn||!ac) return; const t=ac.currentTime; const o=ac.createOscillator(); const g=ac.createGain();
    o.type='square'; o.frequency.value=f; g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.9,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+ms/1000);
    o.connect(g).connect(ac.destination); o.start(t); o.stop(t+ms/1000+0.02);
  };

  // Recording storage (mant√©m as chaves internas; s√≥ mudamos o texto para HAJIME)
  const K={start:'r_start_v11',kotai:'r_kotai_v11',mate:'r_mate_v11',count:'r_count_v11',cfg:'cfg_v11'};
  let rec={start:null,kotai:null,mate:null,count:null,aStart:null,aKotai:null,aMate:null,aCount:null};

  const loadRecs=()=>{
    rec.start=localStorage.getItem(K.start); rec.kotai=localStorage.getItem(K.kotai);
    rec.mate=localStorage.getItem(K.mate); rec.count=localStorage.getItem(K.count);
    rec.aStart=rec.start?new Audio(rec.start):null;
    rec.aKotai=rec.kotai?new Audio(rec.kotai):null;
    rec.aMate=rec.mate?new Audio(rec.mate):null;
    rec.aCount=rec.count?new Audio(rec.count):null;
  };

  const stopClips=()=>{ [rec.aStart,rec.aKotai,rec.aMate,rec.aCount].forEach(a=>{ try{ if(a){a.pause();a.currentTime=0;} }catch(e){} }); };

  const play=async(which)=>{
    if(!audioOn){ toast('Ative o √°udio primeiro.'); return false; }
    const a = (which==='start')?rec.aStart:(which==='kotai')?rec.aKotai:(which==='mate')?rec.aMate:rec.aCount;
    if(!a){ toast('Esse comando n√£o foi gravado.'); return false; }
    try{ stopClips(); a.currentTime=0; await a.play(); return true; }catch(e){ toast('Falha ao tocar √°udio.'); return false; }
  };

  const blobToDataUrl=(b)=>new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(b); });

  const pickMime=()=>{
    const c=['audio/webm;codecs=opus','audio/webm','audio/mp4'];
    for(const m of c){ try{ if(MediaRecorder.isTypeSupported(m)) return m; }catch(e){} }
    return '';
  };

  const requestMic=async()=>{
    try{
      const s = await navigator.mediaDevices.getUserMedia({audio:true});
      s.getTracks().forEach(t=>t.stop());
      toast('Microfone liberado ‚úÖ');
    }catch(e){
      toast('Permiss√£o negada. Verifique Chrome/Android ‚Üí Microfone.');
    }
  };

  const record = async(which, btn)=>{
    if(!navigator.mediaDevices?.getUserMedia){ toast('Grava√ß√£o n√£o suportada.'); return; }
    let stream;
    try{ stream = await navigator.mediaDevices.getUserMedia({audio:true}); }
    catch(e){ toast('Permiss√£o negada. Toque ‚ÄúConfigurar microfone‚Äù.'); return; }

    const chunks=[];
    let mr;
    try{
      const mt=pickMime();
      mr = mt ? new MediaRecorder(stream,{mimeType:mt}) : new MediaRecorder(stream);
    }catch(e){
      stream.getTracks().forEach(t=>t.stop());
      toast('N√£o consegui iniciar a grava√ß√£o neste aparelho.');
      return;
    }

    const stop = async()=>{ try{ mr.stop(); }catch(e){} };

    const old=btn.textContent;
    btn.textContent='‚èπÔ∏è Parar';
    btn.classList.add('warn');
    btn.onclick=stop;

    mr.ondataavailable=(e)=>{ if(e.data?.size) chunks.push(e.data); };
    mr.onstop=async()=>{
      stream.getTracks().forEach(t=>t.stop());
      const blob=new Blob(chunks,{type:mr.mimeType||'audio/webm'});
      const url=await blobToDataUrl(blob);
      localStorage.setItem(K[which], url);
      loadRecs();
      toast('Grava√ß√£o salva ‚úÖ');
      btn.textContent=old;
      btn.classList.remove('warn');
      btn.onclick=()=>record(which,btn);
    };

    mr.start();
    toast('Gravando‚Ä¶ toque de novo para parar');
    setTimeout(()=>{ if(mr.state==='recording') stop(); }, (which==='count')?5200:2800);
  };

  // Timer
  const fmt=(s)=>{ s=Math.max(0,Math.round(s)); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${mm}:${ss}`; };
  const getInt=(id,min,max,def)=>{ const n=parseInt($(id).value,10); if(Number.isNaN(n)) return def; return Math.max(min,Math.min(max,n)); };
  const work=()=>getInt('work',5,600,30);
  const rest=()=>getInt('rest',0,600,10);
  const cd=()=>getInt('cd',0,20,5);
  const rounds=()=>getInt('rounds',1,50,1);

  let list=[], idx=0, round=1, phase='STOP', rem=work(), tot=rem, timer=null, cdPlayed=false;

  const loadList=()=>{
    list=$('list').value.split('\n').map(s=>s.trim()).filter(Boolean);
    if(!list.length) list=['Exerc√≠cio'];
    $('exName').textContent=(phase==='REST30')?'DESCANSO':(list[idx]||'Pronto');
  };

  const ui=()=>{
    $('time').textContent=fmt(rem);
    $('phase').textContent =
      phase==='WORK' ? 'Trabalho' :
      phase==='REST' ? 'Intervalo' :
      phase==='REST30'? 'Descanso 30s' :
      phase==='PAUSE'? 'Pausado' :
      'Parado';
    $('exName').textContent=(phase==='REST30')?'DESCANSO':(list[idx]||'Pronto');
  };

  const stopTimer=()=>{ clearInterval(timer); timer=null; };

  const seg=(ph,sec)=>{ phase=ph; tot=sec; rem=sec; cdPlayed=false; ui(); };

  const canStart=()=>{
    if(!audioOn) return 'Ative o √°udio primeiro.';
    if(!rec.aStart) return 'Grave HAJIME antes de iniciar.';
    const end=$('endCmd').value;
    if(end==='kotai' && !rec.aKotai) return 'Grave KOTAI antes de iniciar.';
    if(end==='mate' && !rec.aMate) return 'Grave MATE antes de iniciar.';
    if($('cdMode').value==='clip' && !rec.aCount) return 'Voc√™ escolheu ‚Äúminha voz‚Äù no 5..1, ent√£o grave ‚Äú5..1‚Äù.';
    return null;
  };

  const startWork=async()=>{
    seg('WORK', work());
    beep(1500,60);
    await play('start'); // sua grava√ß√£o do HAJIME
  };

  const endWork=async()=>{
    beep(1400,100);
    const end=$('endCmd').value;
    if(end==='kotai') await play('kotai');
    else if(end==='mate') await play('mate');
  };

  const startRest=()=>{ const s=rest(); seg('REST', s); if(s===0) next(); };

  const next=async()=>{
    if(idx<list.length-1) idx++;
    else{
      if(round<rounds()){ round++; idx=0; }
      else{ stopAll(true); toast('Treino finalizado'); beep(880,90); return; }
    }
    loadList();
    await startWork();
  };

  const tick=async()=>{
    if(!(phase==='WORK'||phase==='REST'||phase==='REST30')) return;
    rem--;

    if((phase==='REST'||phase==='REST30') && $('cdMode').value==='clip' && cd()>0){
      if(!cdPlayed && rem===cd()){
        cdPlayed=true;
        await play('count');
      }
    }

    if(rem<=0){
      if(phase==='WORK'){ await endWork(); startRest(); return; }
      if(phase==='REST'){ await next(); return; }
      if(phase==='REST30'){ await startWork(); return; }
    }
    ui();
  };

  const run=()=>{ stopTimer(); timer=setInterval(()=>{ tick().catch(()=>{}); },1000); };

  // stopAll(resetUIAfterAudio)
  const stopAll=(hard=false)=>{
    stopTimer();
    stopClips();
    phase='STOP';
    if(hard){
      idx=0; round=1;
      rem=work(); tot=rem;
      loadList();
    }
    ui();
  };

  // Buttons
  $('audio').onclick=async()=>{
    if(audioOn){
      audioOn=false;
      stopClips();
      $('audio').textContent='Ativar √°udio';
      toast('√Åudio desativado');
      return;
    }
    if(!ensureAC()){ toast('√Åudio n√£o suportado.'); return; }
    try{ if(ac.state==='suspended') await ac.resume(); }catch(e){}
    audioOn=true;
    $('audio').textContent='Desativar √°udio';
    toast('√Åudio ativado');
    beep(880,80);
  };

  $('mic').onclick=requestMic;

  $('start').onclick=async()=>{
    loadList();
    if(phase==='STOP'){
      const err=canStart(); if(err){ toast(err); return; }
      idx=0; round=1;
      await startWork();
      run();
      return;
    }
    if(phase==='PAUSE'){
      phase='WORK';
      run(); ui();
    }
  };

  $('pause').onclick=()=>{
    if(phase==='STOP') return;
    if(phase==='PAUSE'){ phase='WORK'; run(); ui(); return; }
    phase='PAUSE'; stopTimer(); ui();
  };

  $('reset').onclick=()=>{ stopAll(true); toast('Zerado'); };

  $('rest30').onclick=()=>{
    loadList();
    idx=0; round=1;
    seg('REST30', 30);
    run();
  };

  $('next').onclick=()=>{ if(phase==='STOP'||phase==='PAUSE'){ toast('Inicie/retome antes.'); return; } next().catch(()=>{}); };

  $('full').onclick=async()=>{
    try{ if(!document.fullscreenElement) await document.documentElement.requestFullscreen(); else await document.exitFullscreen(); }catch(e){}
  };

  // BOT√ÉO MATE: para na hora, fala MATE, e depois volta pro in√≠cio do circuito
  $('mateBtn').onclick=async()=>{
    if(!audioOn){ toast('Ative o √°udio primeiro.'); return; }
    if(!rec.aMate){ toast('Grave o MATE primeiro.'); return; }
    stopTimer();
    phase='STOP';
    ui();
    await play('mate');
    // depois que falar MATE, volta para o in√≠cio pronto para recome√ßar
    idx=0; round=1;
    rem=work(); tot=rem;
    loadList();
    ui();
  };

  $('guide').onclick=()=>{ $('mb').style.display='flex'; };
  $('closeGuide').onclick=()=>{ $('mb').style.display='none'; };
  $('mb').onclick=(e)=>{ if(e.target===$('mb')) $('mb').style.display='none'; };

  $('save').onclick=()=>{
    const data={work:work(),rest:rest(),cd:cd(),cdMode:$('cdMode').value,rounds:rounds(),endCmd:$('endCmd').value,list:$('list').value};
    localStorage.setItem(K.cfg, JSON.stringify(data));
    toast('Config salva ‚úÖ');
  };

  $('load').onclick=()=>{
    const raw=localStorage.getItem(K.cfg); if(!raw){ toast('Nada salvo'); return; }
    try{
      const d=JSON.parse(raw);
      $('work').value=d.work??30; $('rest').value=d.rest??10; $('cd').value=d.cd??5;
      $('cdMode').value=d.cdMode??'silent'; $('rounds').value=d.rounds??1; $('endCmd').value=d.endCmd??'kotai';
      $('list').value=d.list??$('list').value;
      rem=work(); tot=rem;
      loadList(); ui();
      toast('Config carregada ‚úÖ');
    }catch(e){ toast('Erro ao carregar'); }
  };

  $('clearRecs').onclick=()=>{
    [K.start,K.kotai,K.mate,K.count].forEach(k=>localStorage.removeItem(k));
    loadRecs(); toast('Grava√ß√µes apagadas');
  };

  $('recStart').onclick=()=>record('start',$('recStart'));
  $('recKotai').onclick=()=>record('kotai',$('recKotai'));
  $('recMate').onclick=()=>record('mate',$('recMate'));
  $('recCount').onclick=()=>record('count',$('recCount'));

  $('testStart').onclick=()=>play('start');
  $('testKotai').onclick=()=>play('kotai');
  $('testMate').onclick=()=>play('mate');
  $('testCount').onclick=()=>play('count');

  // init
  loadRecs();
  loadList();
  ui();

  // bot√£o vazio (s√≥ pra manter o grid bonito)
  $('noop').onclick=()=>toast(' ');
})();
</script>
</body>
</html>
