<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Timer Circuito ‚Äî Minha Voz (RAJIME / KOTAI / MATE)</title>
  <style>
    :root{
      --bg:#0b0f1a; --card:rgba(255,255,255,.05); --bd:rgba(255,255,255,.12);
      --fg:#eaf0ff; --mut:#a9b5d6; --ok:#3ddc97; --warn:#ffd166; --bad:#ff5d5d;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(900px 700px at 10% 0%,#162246 0%,var(--bg) 60%,#070a12 100%);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px 26px}
    h1{margin:0;font-size:18px}
    .sub{margin:6px 0 0;color:var(--mut);font-size:13px;line-height:1.35}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    @media(min-width:920px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{
      background:linear-gradient(180deg,var(--card),rgba(255,255,255,.02));
      border:1px solid var(--bd); border-radius:18px; padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .top{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-bottom:10px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--bd);
      background:rgba(0,0,0,.18); color:var(--mut); font-size:12px;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.off{background:var(--bad)} .dot.on{background:var(--ok)} .dot.rest{background:var(--warn)}
    .name{font-size:22px;font-weight:900;text-align:center;margin:4px 0 0}
    .big{font-variant-numeric:tabular-nums;font-size:68px;font-weight:900;letter-spacing:1px;text-align:center;margin:6px 0}
    .lbl{color:var(--mut);text-align:center;margin:0 0 10px}
    .barwrap{height:12px;border-radius:999px;overflow:hidden;background:rgba(255,255,255,.08);border:1px solid var(--bd)}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#7aa2ff,#9cf1ff);transition:width .2s linear}
    button{
      width:100%; border:1px solid var(--bd); background:rgba(0,0,0,.18); color:var(--fg);
      border-radius:14px; padding:12px; font-weight:900; font-size:16px;
      touch-action:manipulation;
    }
    button:active{transform:translateY(1px)}
    .primary{background:linear-gradient(180deg,rgba(122,162,255,.95),rgba(122,162,255,.65));color:#071026}
    .ok{background:linear-gradient(180deg,rgba(61,220,151,.95),rgba(61,220,151,.65));color:#05120b}
    .warn{background:linear-gradient(180deg,rgba(255,209,102,.95),rgba(255,209,102,.65));color:#1b1200}
    .bad{background:linear-gradient(180deg,rgba(255,93,93,.95),rgba(255,93,93,.65));color:#1b0000}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .row1{margin-top:10px}
    label{display:block;color:var(--mut);font-size:13px;margin-top:10px}
    input,select,textarea{
      width:100%; margin-top:6px; background:rgba(0,0,0,.22);
      border:1px solid var(--bd); border-radius:12px; padding:10px; color:var(--fg); font-size:14px;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
    .mini{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .mini button{width:auto;font-size:14px;padding:10px;border-radius:12px}
    .hint{color:var(--mut);font-size:12px;line-height:1.35;margin-top:8px}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.78);border:1px solid var(--bd);
      padding:10px 12px;border-radius:999px;color:var(--fg);font-size:13px;
      opacity:0;pointer-events:none;transition:opacity .25s;max-width:92vw;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;z-index:9999;
    }
    .toast.show{opacity:1}
    .back{position:fixed;inset:0;background:rgba(0,0,0,.62);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .back.show{display:flex}
    .modal{
      width:min(860px,96vw);max-height:88vh;overflow:auto;background:rgba(10,14,25,.96);
      border:1px solid var(--bd);border-radius:18px;padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.55)
    }
    .modal p,.modal li{color:var(--mut);line-height:1.45}
    .bannerOk{
      position:fixed;top:10px;left:10px;z-index:99999;
      background:rgba(0,0,0,.55);border:1px solid var(--bd);
      padding:6px 10px;border-radius:999px;font-size:12px;color:#b9ffd9
    }
    .bannerErr{
      position:fixed;top:0;left:0;right:0;z-index:99999;
      background:#b00020;color:#fff;padding:10px;font-family:monospace;font-size:12px
    }
  </style>

  <script>
    // Mostra erro JS na tela (para n√£o ficar "bot√£o morto" sem explica√ß√£o)
    window.addEventListener('error', function(e){
      const d=document.createElement('div');
      d.className='bannerErr';
      d.textContent = 'ERRO JS: ' + (e.message||'') + ' @ ' + (e.filename||'') + ':' + (e.lineno||'');
      document.documentElement.appendChild(d);
    });
  </script>
</head>
<body>
<div class="wrap">
  <h1>Timer de Circuito ‚Äî S√≥ minha voz (RAJIME / KOTAI / MATE)</h1>
  <div class="sub">
    Para gravar, precisa abrir em <b>HTTPS</b> e permitir microfone. (GitHub Pages ok.)
  </div>

  <div class="grid">
    <div class="card">
      <div class="top">
        <div class="pill"><span class="dot off" id="dotPhase"></span><span id="phase">Parado</span></div>
        <div class="pill"><span class="dot off" id="dotAudio"></span><span id="audioState">√Åudio: desativado</span></div>
        <div class="pill">Exerc√≠cio <b id="idx">0/0</b> ‚Ä¢ Volta <b id="round">1</b></div>
      </div>

      <p class="name" id="exName">Pronto</p>
      <div class="big" id="time">00:30</div>
      <p class="lbl" id="lbl">Grave os comandos e aperte Iniciar</p>
      <div class="barwrap"><div class="bar" id="bar"></div></div>

      <div class="row2">
        <button class="primary" id="btnStart">Iniciar</button>
        <button id="btnPause">Pausar</button>
      </div>
      <div class="row2">
        <button id="btnReset">Zerar</button>
        <button class="bad" id="btnRest30">Descanso 30s</button>
      </div>
      <div class="row2">
        <button class="warn" id="btnNext">Pr√≥ximo</button>
        <button id="btnFull">Tela cheia</button>
      </div>

      <div class="row1"><button class="ok" id="btnAudio">Ativar √°udio</button></div>
      <div class="row1"><button class="ok" id="btnMic">Configurar microfone</button></div>
      <div class="row1"><button id="btnGuide">Guia do usu√°rio</button></div>

      <div class="hint">
        Fluxo recomendado: in√≠cio = <b>RAJIME</b>; fim do 30s = <b>KOTAI</b> (troca) ou <b>MATE</b> (parar); intervalo pode ser silencioso.
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Configura√ß√µes</h3>

      <label>Tempo de trabalho (segundos)
        <input type="number" id="work" min="5" max="600" value="30">
      </label>

      <label>Intervalo entre exerc√≠cios (segundos)
        <input type="number" id="rest" min="0" max="600" value="10">
      </label>

      <label>Janela final do intervalo (segundos) ‚Äî para tocar ‚Äú5..1‚Äù
        <input type="number" id="cd" min="0" max="20" value="5">
      </label>

      <label>Contagem no intervalo
        <select id="cdMode">
          <option value="silent" selected>Silenciosa (s√≥ espera)</option>
          <option value="clip">Minha voz (um √°udio ‚Äú5..1‚Äù)</option>
          <option value="off">Desligada</option>
        </select>
      </label>

      <label>Quantas voltas no circuito
        <input type="number" id="rounds" min="1" max="50" value="1">
      </label>

      <label>Comando ao fim do trabalho (fim do 30s)
        <select id="endCmd">
          <option value="kotai" selected>KOTAI (troca)</option>
          <option value="mate">MATE (parar)</option>
          <option value="none">Nenhum</option>
        </select>
      </label>

      <label>Vibra√ß√£o
        <select id="vib">
          <option value="on" selected>Ligada</option>
          <option value="off">Desligada</option>
        </select>
      </label>

      <label>Tentar tela cheia ao iniciar
        <select id="autoFs">
          <option value="off" selected>N√£o</option>
          <option value="on">Sim</option>
        </select>
      </label>

      <label>Lista de exerc√≠cios (um por linha)
        <textarea id="list">Polichinelos
Agachamento
Flex√£o
Prancha</textarea>
      </label>

      <h3 style="margin:12px 0 8px">Grava√ß√µes (minha voz)</h3>
      <div class="mini">
        <button id="recStart">üéôÔ∏è Gravar RAJIME</button>
        <button id="testStart">‚ñ∂Ô∏è Testar RAJIME</button>

        <button id="recKotai">üéôÔ∏è Gravar KOTAI</button>
        <button id="testKotai">‚ñ∂Ô∏è Testar KOTAI</button>

        <button id="recMate">üéôÔ∏è Gravar MATE</button>
        <button id="testMate">‚ñ∂Ô∏è Testar MATE</button>

        <button id="recCount">üéôÔ∏è Gravar ‚Äú5..1‚Äù</button>
        <button id="testCount">‚ñ∂Ô∏è Testar ‚Äú5..1‚Äù</button>

        <button class="bad" id="clearRecs">Apagar grava√ß√µes</button>
        <button id="saveCfg">Salvar</button>
        <button id="loadCfg">Carregar</button>
      </div>

      <div class="hint">
        Se gravar der ‚Äúpermiss√£o negada‚Äù: Chrome ‚Üí Configura√ß√µes ‚Üí Configura√ß√µes do site ‚Üí Microfone ‚Üí Permitir.
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<div class="back" id="back" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
      <h3 style="margin:0">Guia do usu√°rio</h3>
      <button id="closeGuide" style="width:auto;padding:10px 12px;border-radius:12px;font-size:14px">Fechar</button>
    </div>

    <p><b>Primeira vez (em casa):</b></p>
    <ul>
      <li>Abra o link do GitHub Pages (HTTPS).</li>
      <li>Toque <b>Ativar √°udio</b>.</li>
      <li>Toque <b>Configurar microfone</b> ‚Üí <b>Permitir</b>.</li>
      <li>Grave <b>RAJIME</b> e <b>KOTAI</b> (ou <b>MATE</b>, se preferir).</li>
      <li>Opcional: grave ‚Äú<b>5..1</b>‚Äù e selecione ‚ÄúMinha voz‚Äù em Contagem.</li>
      <li>Toque <b>Salvar</b>.</li>
    </ul>

    <p><b>No treino:</b></p>
    <ul>
      <li><b>Iniciar</b> toca RAJIME e come√ßa o tempo.</li>
      <li>No fim dos 30s toca KOTAI (troca) ou MATE (parar), conforme seu ajuste.</li>
      <li>O intervalo pode ser silencioso e reinicia com RAJIME.</li>
      <li><b>Descanso 30s</b> reinicia do come√ßo e faz um descanso longo.</li>
    </ul>

    <p><b>Dica:</b> Aumente o volume de m√≠dia do celular. Se precisar ‚Äúbem alto‚Äù, use caixinha Bluetooth.</p>
  </div>
</div>

<script>
(function(){
  // Banner "JS OK"
  const ok=document.createElement('div');
  ok.className='bannerOk';
  ok.textContent='JS OK';
  document.documentElement.appendChild(ok);

  const $ = (id)=>document.getElementById(id);
  const toast=(m)=>{
    const t=$('toast'); t.textContent=m; t.classList.add('show');
    clearTimeout(toast._); toast._=setTimeout(()=>t.classList.remove('show'),1800);
  };
  const fmt=(s)=>{ s=Math.max(0,Math.round(s)); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${mm}:${ss}`; };
  const vib=(pattern)=>{ if($('vib').value==='on' && navigator.vibrate) navigator.vibrate(pattern); };

  // AudioContext p/ beep de seguran√ßa (mesmo sendo "s√≥ minha voz", ajuda como fallback)
  let ac=null, audioOn=false;
  function ensureAC(){
    if(ac) return true;
    try{ ac=new (window.AudioContext||window.webkitAudioContext)(); return true; }catch(e){ return false; }
  }
  async function enableAudio(){
    if(!ensureAC()){ toast('√Åudio n√£o suportado aqui.'); return; }
    try{ if(ac.state==='suspended') await ac.resume(); }catch(e){}
    audioOn=true;
    $('dotAudio').className='dot on';
    $('audioState').textContent='√Åudio: ativado';
    $('btnAudio').textContent='Desativar √°udio';
    beep(880,80);
  }
  function disableAudio(){
    audioOn=false;
    stopAllClips();
    $('dotAudio').className='dot off';
    $('audioState').textContent='√Åudio: desativado';
    $('btnAudio').textContent='Ativar √°udio';
  }
  function beep(freq=1200,ms=80){
    if(!audioOn||!ac) return;
    const t=ac.currentTime;
    const o=ac.createOscillator();
    const g=ac.createGain();
    o.type='square'; o.frequency.value=freq;
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(0.9,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+ms/1000);
    o.connect(g).connect(ac.destination);
    o.start(t); o.stop(t+ms/1000+0.02);
  }

  // Storage keys
  const K = {
    start:'rec_start_v9', kotai:'rec_kotai_v9', mate:'rec_mate_v9', count:'rec_count_v9',
    cfg:'timer_cfg_v9'
  };

  let rec = { start:null,kotai:null,mate:null,count:null, aStart:null,aKotai:null,aMate:null,aCount:null };

  function loadRecs(){
    rec.start=localStorage.getItem(K.start);
    rec.kotai=localStorage.getItem(K.kotai);
    rec.mate=localStorage.getItem(K.mate);
    rec.count=localStorage.getItem(K.count);
    rec.aStart=rec.start?new Audio(rec.start):null;
    rec.aKotai=rec.kotai?new Audio(rec.kotai):null;
    rec.aMate=rec.mate?new Audio(rec.mate):null;
    rec.aCount=rec.count?new Audio(rec.count):null;
  }
  function stopAllClips(){
    for(const a of [rec.aStart,rec.aKotai,rec.aMate,rec.aCount]){
      try{ if(a){ a.pause(); a.currentTime=0; } }catch(e){}
    }
  }
  async function playClip(which){
    if(!audioOn){ toast('Ative o √°udio primeiro.'); return false; }
    const a = (which==='start')?rec.aStart:(which==='kotai')?rec.aKotai:(which==='mate')?rec.aMate:rec.aCount;
    if(!a){ toast('Esse comando n√£o foi gravado ainda.'); return false; }
    try{
      stopAllClips();
      a.currentTime=0;
      await a.play();
      return true;
    }catch(e){
      toast('Falha ao tocar √°udio (toque em Ativar √°udio e tente de novo).');
      return false;
    }
  }

  async function requestMicPermission(){
    if(!navigator.mediaDevices?.getUserMedia){ toast('Microfone n√£o suportado aqui.'); return; }
    try{
      const s = await navigator.mediaDevices.getUserMedia({audio:true});
      s.getTracks().forEach(t=>t.stop());
      toast('Microfone liberado ‚úÖ');
    }catch(e){
      toast('Permiss√£o negada. Verifique permiss√µes do Chrome/Android.');
    }
  }

  function pickMimeType(){
    const candidates=[
      'audio/webm;codecs=opus',
      'audio/webm',
      'audio/mp4'
    ];
    for(const c of candidates){
      try{ if(window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(c)) return c; }catch(e){}
    }
    return '';
  }

  function blobToDataUrl(blob){
    return new Promise((res,rej)=>{
      const r=new FileReader();
      r.onload=()=>res(r.result);
      r.onerror=rej;
      r.readAsDataURL(blob);
    });
  }

  async function recordClip(which){
    if(!navigator.mediaDevices?.getUserMedia){ toast('Grava√ß√£o n√£o suportada aqui.'); return; }
    let stream=null;
    try{
      stream=await navigator.mediaDevices.getUserMedia({audio:true});
    }catch(e){
      toast('Permiss√£o negada. Toque em ‚ÄúConfigurar microfone‚Äù e permita.');
      return;
    }

    let mr=null;
    const chunks=[];
    const mt=pickMimeType();
    try{
      mr = mt ? new MediaRecorder(stream,{mimeType:mt}) : new MediaRecorder(stream);
    }catch(e){
      stream.getTracks().forEach(t=>t.stop());
      toast('N√£o consegui iniciar gravador neste aparelho.');
      return;
    }

    let stopRequested=false;

    mr.ondataavailable=(e)=>{ if(e.data && e.data.size) chunks.push(e.data); };
    mr.onstop=async()=>{
      try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){}
      const blob=new Blob(chunks,{type:mr.mimeType || 'audio/webm'});
      const url=await blobToDataUrl(blob);
      localStorage.setItem(K[which], url);
      loadRecs();
      toast('Grava√ß√£o salva ‚úÖ');
      restoreRecButton(which);
    };

    setRecButtonStopMode(which, ()=>{ if(stopRequested) return; stopRequested=true; try{ mr.stop(); }catch(e){} });

    mr.start();
    toast('Gravando‚Ä¶ toque novamente para parar');
    // auto-stop seguro
    setTimeout(()=>{
      if(mr && mr.state==='recording'){
        try{ mr.stop(); }catch(e){}
      }
    }, (which==='count')?5200:2800);
  }

  function recBtnId(which){
    return (which==='start')?'recStart':(which==='kotai')?'recKotai':(which==='mate')?'recMate':'recCount';
  }

  const recBtnState = {};
  function setRecButtonStopMode(which, stopFn){
    const id=recBtnId(which);
    const b=$(id);
    recBtnState[which] = { text:b.textContent, cls:b.className, handler:stopFn };
    b.textContent='‚èπÔ∏è Parar';
    b.classList.add('warn');
    b.onclick=stopFn;
  }
  function restoreRecButton(which){
    const id=recBtnId(which);
    const b=$(id);
    const s=recBtnState[which];
    if(!s) return;
    b.textContent=s.text;
    b.className=s.cls || '';
    // volta para gravar
    b.onclick=()=>recordClip(which);
    delete recBtnState[which];
  }

  // Timer / state
  const PH = { STOP:'stop', WORK:'work', REST:'rest', REST30:'rest30', PAUSE:'pause' };
  let ph=PH.STOP, prev=PH.STOP, tmr=null;
  let list=[], idx=0, round=1, rem=30, tot=30;
  let cdPlayed=false;

  const getInt=(id,min,max,def)=>{ const n=parseInt($(id).value,10); if(Number.isNaN(n)) return def; return Math.max(min,Math.min(max,n)); };
  const work=()=>getInt('work',5,600,30);
  const rest=()=>getInt('rest',0,600,10);
  const cd=()=>getInt('cd',0,20,5);
  const rounds=()=>getInt('rounds',1,50,1);

  function loadList(){
    list = $('list').value.split('\n').map(s=>s.trim()).filter(Boolean);
    if(!list.length) list=['Exerc√≠cio'];
    $('idx').textContent = `${Math.min(idx+1,list.length)}/${list.length}`;
  }

  function setPhaseUI(){
    const d=$('dotPhase');
    if(ph===PH.WORK){ d.className='dot on'; $('phase').textContent='Trabalho'; }
    else if(ph===PH.REST||ph===PH.REST30){ d.className='dot rest'; $('phase').textContent = (ph===PH.REST30)?'Descanso':'Intervalo'; }
    else if(ph===PH.PAUSE){ d.className='dot off'; $('phase').textContent='Pausado'; }
    else { d.className='dot off'; $('phase').textContent='Parado'; }
  }

  function ui(){
    $('time').textContent=fmt(rem);
    $('round').textContent=String(round);
    $('idx').textContent=`${Math.min(idx+1,list.length)}/${list.length}`;
    $('exName').textContent = (ph===PH.REST30)?'DESCANSO':(list[idx]||'Pronto');
    $('lbl').textContent = (ph===PH.WORK)?'Trabalhando‚Ä¶':(ph===PH.REST)?'Intervalo‚Ä¶':(ph===PH.REST30)?'Descanso extra‚Ä¶':(ph===PH.PAUSE)?'Pausado':'Grave os comandos e aperte Iniciar';
    $('bar').style.width = `${tot?Math.max(0,Math.min(100,(1-rem/tot)*100)):0}%`;
    setPhaseUI();
  }

  function seg(newPh,sec){
    ph=newPh; tot=sec; rem=sec; cdPlayed=false;
    ui();
  }

  function canStart(){
    if(!audioOn) return 'Ative o √°udio primeiro.';
    if(!rec.aStart) return 'Grave RAJIME antes de iniciar.';
    const end=$('endCmd').value;
    if(end==='kotai' && !rec.aKotai) return 'Grave KOTAI (fim do 30s) antes de iniciar.';
    if(end==='mate' && !rec.aMate) return 'Grave MATE (fim do 30s) antes de iniciar.';
    if($('cdMode').value==='clip' && !rec.aCount) return 'Voc√™ escolheu contagem ‚Äúminha voz‚Äù, ent√£o grave o ‚Äú5..1‚Äù (ou mude para silenciosa).';
    return null;
  }

  async function startWork(){
    seg(PH.WORK, work());
    beep(1500,60); vib([60,40,60]);
    await playClip('start');
  }

  async function endOfWork(){
    beep(1400,100); vib([140,60,140]);
    const end=$('endCmd').value;
    if(end==='kotai') await playClip('kotai');
    else if(end==='mate') await playClip('mate');
  }

  function startRest(){
    const s=rest();
    seg(PH.REST, s);
    if(s===0) nextExercise();
  }

  async function nextExercise(){
    if(idx < list.length-1) idx++;
    else{
      if(round < rounds()){ round++; idx=0; }
      else{
